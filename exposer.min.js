!function(factory){"function"==typeof define&&define.amd?define(["jquery"],factory):factory(jQuery)}(function($){"use strict";function guid(){return(0|65536*(1+Math.random())).toString(16)+(0|65536*(1+Math.random())).toString(16)}function Exposer(o){this.o=$.extend(!0,{},defaultOptions,o),this.v=$.extend(!0,{},defaultVars),this.init(o)}$.fn.exposer=function(options){var exp=null,args=arguments,o=$.extend({},options);return o.selector=this.selector,o.element=$(document),exp=o.element.data("exposer"),void 0!=exp&&void 0!=exp[o.selector]?(exp=exp[o.selector],exp.trigger.apply(exp,args)):exp=new Exposer(o),this};var defaultOptions={hideOnOverlayClick:!0,preload:1,callbacks:{}},defaultVars={dimTimer:null,clickItem:null,activeItem:null,items:[],extensions:["jpg","jpeg","png","gif","tiff","bmp"],videoProviders:{youtube:{regex:["(?:www\\.)?youtu\\.be\\/([0-9a-zA-Z-_]{11})","^(?:https?:\\/\\/)?(?:www\\.)?(?:youtu\\.be\\/|youtube\\.com\\/(?:embed\\/|v\\/|watch\\?v=|watch\\?.+&v=))((\\w|-){11})(?:\\S+)?$"],attributes:{src:"http://www.youtube.com/embed/{1}?rel=0",width:854,height:510,allowfullscreen:null,frameborder:0}},vimeo:{regex:["(?:http://)?(?:www.)?vimeo.com/([0-9])"],attributes:{src:"http://player.vimeo.com/video/{1}",width:854,height:510,allowfullscreen:null,frameborder:0}}}};Exposer.prototype={o:{},v:{},html:{exposer:'<div id="exposer"></div>',header:'<div class="header"><span class="close"></span></div>',content:'<div class="content"><a href="#" class="prev-container"><span class="prev"></span></a><a href="#" class="next-container"><span class="next"></span></a></div>',list:'<ul class="items"></ul>',item:'<li class="item"></li>',itemContainer:'<div class="container"></div>',itemMeta:'<div class="meta"></div>',footer:'<div class="footer"></div>',spinner:'<div class="spinner"></div>'},init:function(){this.o.id=guid(),this.initCallbacks(),this.initEvents();var exposer=this.o.element.data("exposer")||{};return exposer[this.o.selector]=this,this.o.element.data("exposer",exposer),this},initEvents:function(){var self=this,o=this.o;o.element.on("click."+o.id+" touchend."+o.id,o.selector,function(e){return self.validateItem(this.href)?(self.v.clickItem=$(this),self.show(e,$(this)),e.stopPropagation(),e.preventDefault(),!1):void 0})},initListeners:function(){var self=this;$(window).off("resize.exposer"),$(document).off(".exposer"),$(window).on("resize.exposer",function(){self.repositionItem(self.v.activeItem)}),this.v.container.on("click.exposer",function(e){return e.target.classList.contains("close")||self.o.hideOnOverlayClick&&"exposer"==e.target.id?(self.hide(),!1):void 0}),this.v.container.on("click.exposer",".prev-container, .next-container",function(e){return $(e.currentTarget).hasClass("prev-container")?self.prev():self.next(),e.stopPropagation(),e.preventDefault(),!1}),$(document).on("keydown.exposer",function(e){setTimeout(function(){self.keyDown(e)},1)});var px=0,py=0,x=null,y=null,dimmed=!1;$(document).on("mousemove.exposer",function(e){x=e.clientX,y=e.clientY,dimmed&&self.v.container.removeClass("dim")}),self.v.dimTimer=setInterval(function(){px==x&&py==y&&(dimmed=!0,self.v.container.addClass("dim")),px=x,py=y},4e3)},buildExposer:function(){$("#exposer").remove(),this.v.container=$(this.html.exposer),this.v.header=$(this.html.header),this.v.content=$(this.html.content),this.v.list=$(this.html.list),this.v.content.append(this.v.list),this.v.footer=$(this.html.footer),this.v.spinner=$(this.html.spinner),this.v.container.append(this.v.header).append(this.v.spinner).append(this.v.content).append(this.v.footer)},parsePage:function(){var self=this,collectionId=this.v.clickItem.data("collection")||null,itemDefault={type:null,el:null,original:null,link:null,size:null,loaded:!1};if(collectionId){var collection=$(this.o.selector).filter('[data-collection="'+collectionId+'"]');collection.length>=1&&($.each(collection,function(k,v){v==self.v.clickItem[0]&&(self.v.activeItem=k)}),$.each(collection,function(k,v){var item=$.extend({},itemDefault);item.original=$(v),item.link=$(v).attr("href"),self.v.items.push(item),self.buildItem(k)}))}else{var item=$.extend({},itemDefault);this.v.activeItem=0,item.original=this.v.clickItem,item.link=this.v.clickItem.attr("href"),this.v.items.push(item),this.buildItem(0)}},validateItem:function(href){return this.getContentType(href)?!0:!1},show:function(e,el){var st=$(document).scrollTop(),sl=$(document).scrollLeft();$("body").css({overflow:"hidden"}).scrollTop(st).scrollLeft(sl),this.buildExposer(el),this.parsePage(),$("body").append(this.v.container),this.refreshControls(),this.initListeners()},hide:function(){$("body").css({overflow:""}),this.v.container.remove(),clearInterval(this.v.dimTimer),this.o.element.off(".exposer"),this.v=$.extend(!0,{},defaultVars)},preload:function(){var self=this;$.each(this.v.items,function(key,item){key>=self.v.activeItem-self.o.preload&&key<=self.v.activeItem+self.o.preload&&!item.loaded&&self.buildContent(key)})},refreshControls:function(){this.v.container.find(".prev-container").show(),this.v.container.find(".next-container").show(),0===this.v.activeItem&&this.v.container.find(".prev-container").hide(),this.v.activeItem===this.v.items.length-1&&this.v.container.find(".next-container").hide()},next:function(){this.v.activeItem<this.v.items.length-1&&(this.v.activeItem++,this.preload(),this.v.container.find(".active").removeClass("active"),this.repositionItem(this.v.activeItem),this.v.items[this.v.activeItem].el.addClass("active"),this.refreshControls())},prev:function(){this.v.activeItem>0&&(this.v.activeItem--,this.preload(),this.v.container.find(".active").removeClass("active"),this.repositionItem(this.v.activeItem),this.v.items[this.v.activeItem].el.addClass("active"),this.refreshControls())},keyDown:function(e){37==e.which?(this.prev(),e.preventDefault()):39==e.which?(this.next(),e.preventDefault()):27==e.which&&(this.hide(),e.preventDefault())},buildItem:function(key){var item=this.v.items[key];if(!item.loaded){var type=this.getContentType(this.v.items[key].link);if(type){var container=$(this.html.itemContainer),meta=$(this.html.itemMeta);item.el=$(this.html.item).attr("data-key",key).append(container).append(meta),item.type=type,key>=this.v.activeItem-1&&key<=this.v.activeItem+1&&!item.loaded&&this.buildContent(key),this.v.list.append(item.el)}}},buildContent:function(key){var item=this.v.items[key];key==this.v.activeItem&&item.el.addClass("active loading");var content=this["build"+this.upperCase(item.type)](key);content&&item.el.find(".container").append(content),this.repositionItem(key)},buildImage:function(key){var self=this;this.v.activeItem==key&&this.v.spinner.show();var link=this.v.items[key].link,image=new Image,$image=$(image);return image.onload=function(){self.v.activeItem==key&&self.v.spinner.hide();var item=self.v.items[key];item.el.removeClass("loading"),item.loaded=!0;var size={width:image.width,height:image.height,ratio:image.width/image.height};item.size=size,$image.addClass("image loaded"),item.el.find(".container").html($(image)),key==self.v.activeItem&&($image.addClass("fade"),setTimeout(function(){$image.addClass("in")},1),setTimeout(function(){$image.removeClass("fade").removeClass("in")},401)),self.repositionItem(key)},image.src=link,null},buildVideo:function(key){this.v.activeItem==key&&this.v.spinner.hide();var item=this.v.items[key];item.loaded=!0;var link=item.link,iframe=$(document.createElement("iframe")).addClass("video"),provider=this.getVideo(link);return $.each(provider,function(k,v){iframe.attr(k,v)}),item.size={width:provider.width,height:provider.height,ratio:provider.width/provider.height},iframe},getContentType:function(href){var video=!1;if($.each(this.v.videoProviders,function(k,v){$.each(v.regex,function(i,regStr){var regex=new RegExp(regStr,"i");return href.match(regex)?(video=!0,void 0):void 0}),video}),video)return"video";var segments=href.split("."),ext=segments[segments.length-1].split("?");return-1!=this.v.extensions.indexOf(ext[0].toLowerCase())?"image":null},getVideo:function(link){var provider=null;return $.each(this.v.videoProviders,function(k,v){var match=null;if($.each(v.regex,function(i,regStr){var regex=new RegExp(regStr,"i");return match=link.match(regex),match?!1:void 0}),match){var items=match.splice(1),attributes=$.extend({},v.attributes);return $.each(items,function(x,item){x+=1,$.each(attributes,function(i,attr){if(null!==attr){var regex=new RegExp("\\{(\\D+)?("+x+")([^}]+)?\\}","i"),attrMatch=new String(attr).match(regex);if(attrMatch){var ai=attrMatch.splice(1),replacement=(ai[0]||"")+item+(ai[2]||"");attributes[i]=new String(attr).replace(attrMatch[0],replacement)}}})}),provider=attributes,!1}}),provider},repositionItem:function(key){this.v.items[key].loaded&&this.v.activeItem==key&&this.v.spinner.hide();var w=window.innerWidth,h=window.innerHeight,item=this.v.items[key],container=item.el.find(".container")[0],size=item.size||null;if(size){var css={width:size.width<w?size.width:w,height:size.height<h?size.height:h};size.ratio>=1?(css.height=css.width/size.ratio,size.width>w&&(css.width=w,css.height=w/size.ratio),css.height>h&&(css.height=h,css.width=h*size.ratio)):(css.width=css.height*size.ratio,size.height>h&&(css.height=h,css.width=h*size.ratio),css.width>w&&(css.width=w,css.height=w/size.ratio)),container.style.width=css.width+"px",container.style.height=css.height+"px"}},destroy:function(){this.o.element.off("click."+this.o.id);var exposer=this.o.element.data("exposer");delete exposer[this.o.selector],this.o.element.data("exposer",exposer),clearInterval(this.v.dimTimer)},initCallbacks:function(){var self=this;$.each(this.o.callbacks,function(k){self.o.callbacks[k]=function(){var args=Array.prototype.slice.call(arguments);return self.o.element.triggerHandler(k,args)}})},trigger:function(name){var args=Array.prototype.slice.call(arguments,1);return this.o.callbacks[name]&&this.o.callbacks[name].apply(this,args)===!1?!1:this[name]&&this[name].apply(this,args)===!1?!1:!0},upperCase:function(string){return string.toLowerCase().replace(/\b[a-z]/g,function(letter){return letter.toUpperCase()})}}});